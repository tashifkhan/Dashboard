---
import Layout from "../../../layouts/Layout.astro";
import MarkdownRenderer from "../../../components/MarkdownRenderer.astro";
import {
	getAllDocs,
	getSidebar,
	getDocPagination,
	type SidebarItem,
} from "../../../utils/docs";
import { Button } from "@/components/ui/button";
import {
	ChevronRight,
	Menu,
	X,
	ChevronLeft,
	FileText,
	Github,
	ExternalLink,
} from "lucide-react";
import { allProjects, type Project } from "../../../data/projects";

export async function getStaticPaths() {
	const docs = getAllDocs();
	return docs;
}

const { project, slug, content, title } = Astro.props;
const sidebar = getSidebar(project);
const { prev, next } = getDocPagination(project, slug);

// Find current project metadata
const currentProject = allProjects.find((p) => p.slug === project);

// Helper to check if a link is active
const isActive = (itemSlug: string) => {
	// Current page slug vs item slug
	// item slug is like "agentic-browser/1-overview"
	// current url is /docs/agentic-browser/1-overview
	const currentPath = `${project}/${slug}`;
	return currentPath === itemSlug;
};

// Recursive sidebar component
---

<Layout
	title={`${project.replace(/-/g, " ")} Docs | ${title.replace(/^[\d.\s]+/, "")}`}
>
	<div class="flex h-screen overflow-hidden bg-background text-foreground">
		<aside
			class="hidden lg:block w-72 border-r border-border bg-muted/10 shrink-0 h-full overflow-y-auto"
		>
			<div class="h-full flex flex-col">
				<div
					class="p-4 border-b border-border sticky top-0 bg-muted/10 z-10 backdrop-blur-sm"
				>
					<h2
						class="font-semibold text-lg tracking-tight capitalize flex items-center gap-2"
					>
						<FileText className="w-5 h-5 text-muted-foreground" />
						{project.replace(/-/g, " ")}
					</h2>
					<p class="text-xs text-muted-foreground mt-1 ml-7">Documentation</p>

					<div class="flex gap-2 mt-4">
						{
							currentProject?.live_website_url && (
								<Button
									size="sm"
									variant="outline"
									className="flex-1 h-8 text-xs"
									asChild
								>
									<a
										href={currentProject.live_website_url}
										target="_blank"
										rel="noopener noreferrer"
									>
										<ExternalLink className="w-3 h-3 mr-2" />
										Live Demo
									</a>
								</Button>
							)
						}
						<Button
							size="sm"
							variant="outline"
							className="flex-1 h-8 text-xs"
							asChild
						>
							<a
								href={currentProject?.github_link ||
									`https://github.com/tashifkhan/${project}`}
								target="_blank"
								rel="noopener noreferrer"
								class="flex items-center gap-0.5"
							>
								<Github className="w-3 h-3 mr-2" />
								GitHub
							</a>
						</Button>
					</div>
				</div>
				<div class="flex-1 overflow-y-auto py-4">
					<div class="px-4 space-y-1">
						{
							sidebar.map((item: SidebarItem) => (
								<div class="space-y-1">
									{item.children && item.children.length > 0 ? (
										<div class="mb-4">
											<h4 class="mb-1 rounded-md px-2 py-1 text-sm font-semibold tracking-tight">
												{item.title}
											</h4>
											<div class="grid grid-flow-row auto-rows-max text-sm gap-0.5 ml-3 border-l border-border/50 pl-2">
												{item.children.map((child: SidebarItem) =>
													// Level 2
													child.children && child.children.length > 0 ? (
														<div class="space-y-0.5">
															<div class="px-2 py-1.5 text-muted-foreground/70 font-medium text-xs uppercase tracking-wider">
																{child.title}
															</div>
															{child.children.map((grandChild: SidebarItem) => (
																<a
																	href={`/docs/${grandChild.slug}`}
																	class:list={[
																		"group flex w-full items-center rounded-md border border-transparent px-2 py-1.5 hover:bg-muted hover:text-foreground text-muted-foreground transition-colors border-l border-border/40 ml-2 pl-4",
																		isActive(grandChild.slug)
																			? "bg-muted font-medium text-foreground border-primary/50"
																			: "hover:border-foreground/20",
																	]}
																>
																	{grandChild.title}
																</a>
															))}
														</div>
													) : (
														<a
															href={`/docs/${child.slug}`}
															class:list={[
																"group flex w-full items-center rounded-md border border-transparent px-2 py-1.5 hover:bg-muted hover:text-foreground text-muted-foreground transition-colors",
																isActive(child.slug)
																	? "bg-muted font-medium text-foreground"
																	: "",
															]}
														>
															{child.title}
														</a>
													)
												)}
											</div>
										</div>
									) : (
										// Level 1 leaf
										<a
											href={`/docs/${item.slug}`}
											class:list={[
												"group flex w-full items-center rounded-md border border-transparent px-2 py-1.5 hover:bg-muted hover:text-foreground text-muted-foreground transition-colors",
												isActive(item.slug)
													? "bg-muted font-medium text-foreground"
													: "",
											]}
										>
											{item.title}
										</a>
									)}
								</div>
							))
						}
					</div>
				</div>
			</div>
		</aside>

		<!-- Mobile Sidebar Toggle -->
		<div class="lg:hidden fixed top-4 right-4 z-40">
			<Button
				variant="outline"
				size="icon"
				className="bg-background shadow-md"
				id="open-sidebar"
			>
				<Menu className="h-4 w-4" />
			</Button>
		</div>

		<!-- Mobile Sidebar Overlay -->
		<div
			id="mobile-sidebar-overlay"
			class="fixed inset-0 z-50 bg-black/80 lg:hidden hidden backdrop-blur-sm transition-all duration-200 opacity-0 data-[state=open]:opacity-100"
		>
		</div>

		<!-- Mobile Sidebar Content -->
		<div
			id="mobile-sidebar"
			class="fixed inset-y-0 left-0 z-50 h-full w-3/4 max-w-sm border-r border-border bg-background p-6 shadow-lg transition-transform duration-300 ease-in-out -translate-x-full lg:hidden data-[state=open]:translate-x-0"
		>
			<div class="flex flex-col mb-6">
				<div class="flex items-center justify-between mb-4">
					<h2
						class="font-semibold text-lg tracking-tight capitalize flex items-center gap-2"
					>
						<FileText className="w-5 h-5 text-muted-foreground" />
						{project.replace(/-/g, " ")}
					</h2>
					<Button variant="ghost" size="icon" id="close-sidebar">
						<X className="h-4 w-4" />
					</Button>
				</div>

				<div class="flex gap-2">
					{
						currentProject?.live_website_url && (
							<Button
								size="sm"
								variant="outline"
								className="flex-1 h-8 text-xs"
								asChild
							>
								<a
									href={currentProject.live_website_url}
									target="_blank"
									rel="noopener noreferrer"
								>
									<ExternalLink className="w-3 h-3 mr-2" />
									Live
								</a>
							</Button>
						)
					}
					<Button
						size="sm"
						variant="outline"
						className="flex-1 h-8 text-xs"
						asChild
					>
						<a
							href={currentProject?.github_link ||
								`https://github.com/tashifkhan/${project}`}
							target="_blank"
							rel="noopener noreferrer"
						>
							<Github className="w-3 h-3 mr-2" />
							GitHub
						</a>
					</Button>
				</div>
			</div>
			<div class="h-[calc(100vh-8rem)] overflow-y-auto">
				<div class="space-y-1">
					{
						sidebar.map((item) => (
							<div class="space-y-1">
								{item.children && item.children.length > 0 ? (
									<div class="mb-4">
										<h4 class="mb-1 rounded-md px-2 py-1 text-sm font-semibold tracking-tight">
											{item.title}
										</h4>
										<div class="grid grid-flow-row auto-rows-max text-sm gap-0.5 ml-3 border-l border-border/50 pl-2">
											{item.children.map((child: SidebarItem) =>
												// Level 2
												child.children && child.children.length > 0 ? (
													<div class="space-y-0.5">
														<div class="px-2 py-1.5 text-muted-foreground/70 font-medium text-xs uppercase tracking-wider">
															{child.title}
														</div>
														{child.children.map((grandChild: SidebarItem) => (
															<a
																href={`/docs/${grandChild.slug}`}
																class:list={[
																	"group flex w-full items-center rounded-md border border-transparent px-2 py-1.5 hover:bg-muted hover:text-foreground text-muted-foreground transition-colors border-l border-border/40 ml-2 pl-4",
																	isActive(grandChild.slug)
																		? "bg-muted font-medium text-foreground border-primary/50"
																		: "hover:border-foreground/20",
																]}
															>
																{grandChild.title}
															</a>
														))}
													</div>
												) : (
													<a
														href={`/docs/${child.slug}`}
														class:list={[
															"group flex w-full items-center rounded-md border border-transparent px-2 py-1.5 hover:bg-muted hover:text-foreground text-muted-foreground transition-colors",
															isActive(child.slug)
																? "bg-muted font-medium text-foreground"
																: "",
														]}
													>
														{child.title}
													</a>
												)
											)}
										</div>
									</div>
								) : (
									<a
										href={`/docs/${item.slug}`}
										class:list={[
											"group flex w-full items-center rounded-md border border-transparent px-2 py-1.5 hover:bg-muted hover:text-foreground text-muted-foreground transition-colors",
											isActive(item.slug)
												? "bg-muted font-medium text-foreground"
												: "",
										]}
									>
										{item.title}
									</a>
								)}
							</div>
						))
					}
				</div>
			</div>
		</div>

		<script>
			const openBtn = document.getElementById("open-sidebar");
			const closeBtn = document.getElementById("close-sidebar");
			const overlay = document.getElementById("mobile-sidebar-overlay");
			const sidebar = document.getElementById("mobile-sidebar");

			function toggleSidebar(show: boolean) {
				if (!sidebar || !overlay) return;

				if (show) {
					sidebar.dataset.state = "open";
					overlay.classList.remove("hidden");
					// small delay to allow display:block to apply before opacity transition
					requestAnimationFrame(() => {
						if (overlay) overlay.dataset.state = "open";
					});
				} else {
					sidebar.removeAttribute("data-state");
					overlay.removeAttribute("data-state");
					setTimeout(() => {
						if (overlay) overlay.classList.add("hidden");
					}, 200);
				}
			}

			openBtn?.addEventListener("click", () => toggleSidebar(true));
			closeBtn?.addEventListener("click", () => toggleSidebar(false));
			overlay?.addEventListener("click", () => toggleSidebar(false));
		</script>

		<main
			class="flex-1 min-w-0 h-full overflow-y-auto py-10 lg:py-12 px-4 sm:px-6 lg:px-8"
		>
			<div class="mx-auto max-w-4xl">
				<div
					class="mb-4 flex flex-wrap items-center gap-1.5 text-sm text-muted-foreground"
				>
					<a
						href="/"
						class="hover:text-foreground hover:underline transition-colors"
						>Home</a
					>
					<ChevronRight className="h-3.5 w-3.5 shrink-0 opacity-50" />
					<a
						href="/projects"
						class="hover:text-foreground hover:underline transition-colors"
						>Projects</a
					>
					<ChevronRight className="h-3.5 w-3.5 shrink-0 opacity-50" />
					<span class="font-medium text-foreground/80 capitalize"
						>{project.replace(/-/g, " ")}</span
					>
					{
						(() => {
							// Find path to current item
							const currentPath = `${project.toLowerCase()}/${slug}`;
							const findPath = (
								items: SidebarItem[],
								target: string
							): SidebarItem[] | null => {
								for (const item of items) {
									if (item.slug === target) return [item];
									if (item.children) {
										const found = findPath(item.children, target);
										if (found) return [item, ...found];
									}
								}
								return null;
							};

							const breadcrumbs = findPath(sidebar, currentPath);

							if (breadcrumbs) {
								return breadcrumbs.map((item, index) => (
									<>
										<ChevronRight className="h-3.5 w-3.5 shrink-0 opacity-50" />
										<span
											class={`capitalize truncate max-w-[150px] ${index === breadcrumbs.length - 1 ? "text-foreground font-semibold" : "text-foreground/80"}`}
										>
											{item.title}
										</span>
									</>
								));
							}
							return null;
						})()
					}
				</div>

				<MarkdownRenderer
					content={content}
					project={project}
					githubBaseUrl={`https://github.com/tashifkhan/${project}`}
				/>

				<div
					class="mt-16 pt-8 border-t border-border flex justify-between gap-4"
				>
					{
						prev ? (
							<Button
								variant="outline"
								className="flex-1 justify-start h-auto py-4 px-4 whitespace-normal text-left"
								asChild
							>
								<a href={`/docs/${prev.slug}`}>
									<div class="flex flex-col gap-1 items-start">
										<span class="text-xs text-muted-foreground flex items-center gap-1">
											<ChevronLeft className="w-3 h-3" /> Previous
										</span>
										<span class="font-medium text-base truncate w-full">
											{prev.title}
										</span>
									</div>
								</a>
							</Button>
						) : (
							<div class="flex-1" />
						)
					}

					{
						next && (
							<Button
								variant="outline"
								className="flex-1 justify-end h-auto py-4 px-4 whitespace-normal text-right"
								asChild
							>
								<a href={`/docs/${next.slug}`}>
									<div class="flex flex-col gap-1 items-end">
										<span class="text-xs text-muted-foreground flex items-center gap-1">
											Next <ChevronRight className="w-3 h-3" />
										</span>
										<span class="font-medium text-base truncate w-full">
											{next.title}
										</span>
									</div>
								</a>
							</Button>
						)
					}
				</div>
			</div>
		</main>
	</div>
</Layout>
