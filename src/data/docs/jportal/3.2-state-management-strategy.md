# State Management Strategy

Relevant source files

* [jportal/package-lock.json](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/package-lock.json)
* [jportal/package.json](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/package.json)
* [jportal/src/App.jsx](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx)
* [jportal/src/components/Attendance.jsx](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Attendance.jsx)
* [jportal/src/components/Grades.jsx](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Grades.jsx)
* [jportal/src/components/Login.jsx](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Login.jsx)

This page documents the state management architecture in JPortal, including how application state is organized, stored, and passed through the component hierarchy. The focus is on the multi-layer React state pattern used throughout the application, persistence mechanisms, and the relationship between component state and data fetching.

For information about data fetching and the portal abstraction layer, see [Data Layer & API Integration](/codeblech/jportal/3.3-data-layer-and-api-integration). For theme-specific state management using Zustand, see [Theme System](/codeblech/jportal/3.4-theme-system).

---

## Overview

JPortal uses a **hybrid state management approach** combining:

* **React `useState` hooks** for local component state
* **Extensive props drilling** from root components to feature modules
* **Zustand store** for global theme state
* **localStorage** for persistence of credentials and user preferences
* **TanStack Query** (available but minimally used in current implementation)

The application does not use a centralized state management library like Redux. Instead, state is **colocated with components** and passed down through props. The root `App` component manages authentication state, while `AuthenticatedApp` acts as a **state coordinator** for all feature modules.

Sources: [jportal/src/App.jsx1-376](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L1-L376) [jportal/package.json25](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/package.json#L25-L25)

---

## State Hierarchy

The state management architecture follows a three-tier hierarchy:

![Architecture Diagram](images/3.2-state-management-strategy_diagram_1.png)
```

Sources: [jportal/src/App.jsx32-219](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L32-L219) [jportal/src/App.jsx243-373](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L243-L373)

---

## App-Level State

The `App` component manages **authentication and loading state** at the application root:

| State Variable | Type | Purpose | Persistence |
| --- | --- | --- | --- |
| `isAuthenticated` | `boolean` | Whether user is logged in | No |
| `isDemoMode` | `boolean` | Whether using mock data | No |
| `isLoading` | `boolean` | Initial authentication check | No |
| `error` | `string | null` | Auto-login error messages | No |

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_2.png)
```

The `App` component also manages **portal instance selection**:

* `realPortal` - Instance of `WebPortal` from `jsjiit` library
* `mockPortal` - Instance of `MockWebPortal` for demo mode
* `activePortal` - Computed based on `isDemoMode` state

Sources: [jportal/src/App.jsx243-251](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L243-L251) [jportal/src/App.jsx28-29](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L28-L29)

---

## AuthenticatedApp State Coordination

`AuthenticatedApp` serves as a **state hub**, declaring and managing state for all feature modules. This component contains **90+ lines of state declarations** organized by feature domain.

### Attendance State Cluster

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_3.png)
```

The `attendanceGoal` state includes **localStorage persistence**:

```
```
// Initial load from localStorage
const [attendanceGoal, setAttendanceGoal] = useState(() => {
  const savedGoal = localStorage.getItem("attendanceGoal");
  return savedGoal ? parseInt(savedGoal) : 75;
});

// Persistence effect
useEffect(() => {
  localStorage.setItem("attendanceGoal", attendanceGoal.toString());
}, [attendanceGoal]);
```
```

Sources: [jportal/src/App.jsx33-50](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L33-L50) [jportal/src/App.jsx52-61](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L52-L61) [jportal/src/App.jsx76-77](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L76-L77) [jportal/src/App.jsx98-100](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L98-L100)

### Grades State Cluster

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_4.png)
```

Sources: [jportal/src/App.jsx40-41](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L40-L41) [jportal/src/App.jsx44](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L44-L44) [jportal/src/App.jsx66-96](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L66-L96)

### Other Feature State Clusters

**Subjects State:**

* `subjectData` - Registered subjects by semester
* `subjectSemestersData` - Available semesters
* `selectedSubjectsSem` - Currently selected semester

**Exams State:**

* `examSchedule` - Exam schedule data by semester/event
* `examSemesters` - Available semesters
* `selectedExamSem` - Selected semester
* `selectedExamEvent` - Selected exam event

**Profile State:**

* `profileData` - User profile information

Sources: [jportal/src/App.jsx37-38](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L37-L38) [jportal/src/App.jsx45](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L45-L45) [jportal/src/App.jsx79-83](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L79-L83) [jportal/src/App.jsx64](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L64-L64)

---

## Props Drilling Pattern

Feature components receive state and setter functions through props. The `Attendance` component demonstrates the extensive props drilling:

### Attendance Component Props

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_5.png)
```

Sources: [jportal/src/App.jsx110-141](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L110-L141) [jportal/src/components/Attendance.jsx12-40](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Attendance.jsx#L12-L40)

### Grades Component Props

The `Grades` component receives **25+ props**:

* Core data: `gradesData`, `semesterData`, `gradeCards`, `marksData`
* UI state: `activeTab`, `gradeCardLoading`, `isDownloadDialogOpen`
* Selection state: `selectedGradeCardSem`, `selectedMarksSem`
* Available options: `gradeCardSemesters`, `marksSemesters`
* All corresponding setter functions

Sources: [jportal/src/App.jsx144-181](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L144-L181) [jportal/src/components/Grades.jsx13-46](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Grades.jsx#L13-L46)

---

## Data Caching Strategy

Feature components implement **client-side caching** by storing fetched data in state objects keyed by identifiers:

### Cache-by-ID Pattern

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_6.png)
```

**Cache Check Pattern** (from Attendance component):

```
```
const handleSemesterChange = async (value) => {
  const semester = semestersData.semesters.find(sem => sem.registration_id === value);
  setSelectedSem(semester);
  setIsAttendanceDataLoading(true);

  try {
    // Check cache first
    if (attendanceData[value]) {
      setIsAttendanceDataLoading(false);
      return;  // Use cached data
    }

    // Fetch and cache
    const data = await w.get_attendance(header, semester);
    setAttendanceData(prev => ({
      ...prev,
      [value]: data
    }));
  } finally {
    setIsAttendanceDataLoading(false);
  }
}
```
```

Sources: [jportal/src/components/Attendance.jsx100-131](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Attendance.jsx#L100-L131) [jportal/src/components/Grades.jsx211-233](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Grades.jsx#L211-L233)

---

## Persistence Mechanisms

JPortal uses **localStorage** for persisting specific state across sessions:

### Persisted State Table

| Key | Type | Location | Purpose |
| --- | --- | --- | --- |
| `username` | `string` | Login flow | Auto-login credentials |
| `password` | `string` | Login flow | Auto-login credentials |
| `attendanceGoal` | `string` | Attendance | User's attendance target % |
| Theme state | JSON | Zustand persist | Theme preset and mode |

### Auto-Login Flow

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_7.png)
```

Sources: [jportal/src/App.jsx252-288](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L252-L288) [jportal/src/components/Login.jsx54-55](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Login.jsx#L54-L55)

---

## State Initialization Patterns

Feature components follow a **fetch-on-mount** pattern with conditional initialization:

### Example: Attendance Initialization

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_8.png)
```

This pattern prevents **redundant fetches** when navigating between routes, as `AuthenticatedApp` maintains state across route changes.

Sources: [jportal/src/components/Attendance.jsx41-98](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Attendance.jsx#L41-L98)

---

## State Update Patterns

### Immutable Updates

All state updates follow React's **immutable update pattern**:

```
```
// Adding to cache
setAttendanceData(prev => ({
  ...prev,
  [semesterId]: newData
}));

// Updating nested state
setGradeCards(prev => ({
  ...prev,
  [value]: data
}));
```
```

### Async State Updates

Components manage **loading states** around async operations:

```
```
setMarksLoading(true);
try {
  // Fetch data
  const result = await processPdfMarks();
  setMarksSemesterData(result);
  setMarksData(prev => ({
    ...prev,
    [selectedMarksSem.registration_id]: result
  }));
} catch (error) {
  console.error("Failed to load marks:", error);
} finally {
  setMarksLoading(false);
}
```
```

Sources: [jportal/src/components/Grades.jsx122-200](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Grades.jsx#L122-L200)

---

## TanStack Query Integration

While **TanStack Query** is installed and configured, the current implementation uses minimal server state management through it:

```
```
const queryClient = new QueryClient();

// Wrapped in App.jsx
<QueryClientProvider client={queryClient}>
  {/* App content */}
</QueryClientProvider>
```
```

The `queryClient` is available for use but most data fetching is handled through **manual state management** with `useState` and `useEffect` hooks.

Sources: [jportal/src/App.jsx23-25](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L23-L25) [jportal/src/App.jsx319-371](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L319-L371) [jportal/package.json25](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/package.json#L25-L25)

---

## Subject-Specific Caching: Daily Attendance

The `Attendance` component implements a sophisticated **progressive loading pattern** for daily attendance data:

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_9.png)
```

The `subjectCacheStatus` state tracks fetch status for each subject, enabling a **progress indicator UI** displayed in a bottom sheet:

Sources: [jportal/src/components/Attendance.jsx214-231](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Attendance.jsx#L214-L231) [jportal/src/components/Attendance.jsx407-468](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/components/Attendance.jsx#L407-L468)

---

## Refactoring Opportunities

The current state management strategy has several characteristics that suggest **potential refactoring**:

### Observed Patterns

1. **Excessive Props Drilling**: Components receive 20+ props, making the component interface verbose
2. **State Duplication**: Similar caching patterns repeated across features (attendance, grades, exams)
3. **Mixed Concerns**: UI state (dialogs, tabs) mixed with data state in the same component
4. **No Separation**: Loading and error states managed separately for each feature

### Alternative Approaches

```
![Architecture Diagram](images/3.2-state-management-strategy_diagram_10.png)

The application already includes **TanStack Query** in dependencies, suggesting migration to server state management patterns may be planned for future iterations.

Sources: [jportal/package.json25](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/package.json#L25-L25) [jportal/src/App.jsx23-25](https://github.com/codeblech/jportal/blob/4df0fde4/jportal/src/App.jsx#L23-L25)

---

## Summary

JPortal's state management follows a **colocated, props-based architecture**:

* **App Component**: Authentication and portal selection
* **AuthenticatedApp**: Central state coordinator for all features
* **Feature Components**: Receive state/setters via props, implement caching
* **Persistence**: localStorage for credentials and user preferences
* **Theme**: Separate Zustand store (see [Theme System](/codeblech/jportal/3.4-theme-system))

This approach prioritizes **simplicity and explicit data flow** at the cost of verbose component interfaces. The pattern works well for the application's current scale but exhibits characteristics that may benefit from more sophisticated state management as the application grows.