---
import { Github, ExternalLink, Pin, FileText, GitFork } from "lucide-react";
import type { Project } from "../data/projects";
import {
	Card,
	CardContent,
	CardFooter,
	CardHeader,
	CardTitle,
	CardDescription,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";

interface Props {
	project: Project;
}

const { project } = Astro.props as Props;
const languagesToShow = project.languages.slice(0, 3);
const moreLanguages = Math.max(0, project.languages.length - 3);
---

<a
	href={`/projects/${project.slug}`}
	class="block h-full group focus:outline-none"
	data-project-card
	data-pinned={project.pinned ? "true" : "false"}
>
	<Card
		className={cn(
			"h-full flex flex-col overflow-hidden border-border/50 bg-card/50 backdrop-blur-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 dark:hover:shadow-primary/5 hover:border-primary/20",
			project.pinned && "border-primary/30 dark:border-primary/20"
		)}
	>
		<CardHeader className="p-6 pb-2 space-y-2.5 relative">
			{
				project.pinned && (
					<div class="absolute top-0 right-0 p-3">
						<Pin className="w-4 h-4 text-primary rotate-45" />
					</div>
				)
			}
			<CardTitle
				className="text-xl font-bold tracking-tight group-hover:text-primary transition-colors"
				data-project-title
			>
				{project.title}
			</CardTitle>
			<!-- {
				project.parentRepo && (
					<div class="flex items-center gap-1 text-xs text-muted-foreground -mt-1 pb-1">
						<GitFork className="w-3 h-3" />
						<span>Forked from {project.parentRepo}</span>
					</div>
				)
			} -->
			<CardDescription
				className="line-clamp-3 leading-relaxed"
				data-project-description
			>
				{project.description}
			</CardDescription>
		</CardHeader>

		<CardContent className="p-6 py-2 flex-1">
			<div class="flex flex-wrap gap-1.5 mt-2">
				{
					languagesToShow.map((lang) => (
						<Badge
							variant="secondary"
							className="text-[10px] font-medium bg-secondary/50 hover:bg-secondary/70 transition-colors"
							data-project-language
						>
							{lang}
						</Badge>
					))
				}
				{
					moreLanguages > 0 && (
						<Badge variant="outline" className="text-[10px] font-medium">
							+{moreLanguages}
						</Badge>
					)
				}
			</div>
		</CardContent>

		<CardFooter className="p-6 pt-2 mt-auto flex items-center gap-3">
			{
				project.live_website_url && (
					<Button
						variant="default"
						size="sm"
						className="h-8 text-xs gap-1.5 shadow-sm"
						data-live-link
						data-url={project.live_website_url}
					>
						<ExternalLink className="w-3.5 h-3.5" />
						Live Demo
					</Button>
				)
			}
			{
				project.docs_slug && (
					<Button
						variant="secondary"
						size="sm"
						className="h-8 text-xs gap-1.5 shadow-sm"
						data-docs-link
						data-url={`/docs/${project.docs_slug}`}
					>
						<FileText className="w-3.5 h-3.5" />
						Docs
					</Button>
				)
			}
			<Button
				variant="outline"
				size="sm"
				className="h-8 text-xs gap-1.5 bg-background/50 backdrop-blur-sm"
				data-github-link
				data-url={project.github_link}
			>
				<Github className="w-3.5 h-3.5" />
				Source
			</Button>
			{
				(project.stars ?? 0) > 0 && (
					<div class="flex items-center gap-1 text-xs text-muted-foreground ml-auto">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="12"
							height="12"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							class="text-primary"
						>
							<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
						</svg>
						{project.stars}
					</div>
				)
			}
		</CardFooter>
	</Card>
</a>

<script>
	function initProjectCardHandlers() {
		// Use event delegation on the document to handle all project card buttons
		document.addEventListener("click", (e) => {
			const target = e.target as HTMLElement;
			const button = target.closest(
				"[data-live-link], [data-docs-link], [data-github-link]"
			) as HTMLElement;

			if (button) {
				e.preventDefault();
				e.stopPropagation();

				const url = button.getAttribute("data-url");
				if (!url) return;

				if (button.hasAttribute("data-docs-link")) {
					window.location.href = url;
				} else {
					window.open(url, "_blank");
				}
			}
		});

		// Handle keyboard navigation for buttons
		document.addEventListener("keydown", (e) => {
			const target = e.target as HTMLElement;
			const button = target.closest(
				"[data-live-link], [data-docs-link], [data-github-link]"
			) as HTMLElement;

			if (button && (e.key === "Enter" || e.key === " ")) {
				e.preventDefault();
				button.click();
			}
		});
	}

	// Initialize on first load
	initProjectCardHandlers();

	// If using view transitions or similar, re-initialize if needed
	document.addEventListener("astro:after-swap", initProjectCardHandlers);
</script>
