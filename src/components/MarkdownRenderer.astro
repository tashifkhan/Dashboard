---
import { renderMarkdownToHtml } from "../lib/renderMarkdown";

const { content, githubBaseUrl } = Astro.props;

let html = "";

function convertRelativeUrl(url: string): string {
	if (!githubBaseUrl) return url;
	if (url.startsWith("http://") || url.startsWith("https://")) return url;

	// Convert GitHub URL to raw.githubusercontent.com for images
	let baseUrl = githubBaseUrl;
	if (
		baseUrl.includes("github.com") &&
		!baseUrl.includes("raw.githubusercontent.com")
	) {
		baseUrl =
			baseUrl.replace("github.com", "raw.githubusercontent.com") + "/main";
	}

	let convertedUrl = url;
	if (url.startsWith("./")) {
		convertedUrl = baseUrl + "/" + url.substring(2);
	} else if (url.startsWith("../")) {
		convertedUrl = baseUrl + "/" + url.replace(/^\.\.\//, "");
	} else if (url.startsWith("/")) {
		convertedUrl = baseUrl + url;
	} else if (!url.includes("://") && !url.startsWith("#")) {
		convertedUrl = baseUrl + "/" + url;
	}
	return convertedUrl;
}

function enhanceHtml(rawHtml: string): string {
	let html = rawHtml;

	// Inline code - Enhanced styling using Shadcn variables
	// Note: rehype-pretty-code might have already styled inline code if configured,
	// but we aren't using it for inline code yet, so we keep this basic styling.
	// We strictly avoid matching <pre> content by ensuring we are targeting isolated <code> tags.
	// Using a negative lookbehind/lookahead is hard in JS regex, but we can rely on
	// the fact that rehype-pretty-code outputs <pre><code>...</code></pre>.
	// Simplified approach: Only replace <code> that isn't inside a pre.
	// Since we are doing regex on string, this is flaky.
	// Better: Rely on browser CSS or let this run and hope it doesn't break pre blocks.
	// Using the existing regex `<code>([^<\n]+)</code>` usually avoids multiline pre blocks
	// but might catch single line ones.
	html = html.replace(
		/(?<!<pre[^>]*>)<code>([^<\n]+)<\/code>(?!<\/pre>)/g,
		'<code class="relative rounded bg-muted px-[0.3rem] py-[0.2rem] font-mono text-sm font-semibold text-foreground border border-border">$1</code>'
	);

	// Headers - Enhanced with better typography and spacing
	html = html.replace(
		/<h1>(.*?)<\/h1>/g,
		'<h1 class="scroll-m-20 text-3xl sm:text-4xl font-extrabold tracking-tight lg:text-5xl mb-6 mt-8 first:mt-0 text-foreground border-b border-border pb-3">$1</h1>'
	);
	html = html.replace(
		/<h2>(.*?)<\/h2>/g,
		'<h2 class="scroll-m-20 border-b border-border pb-2 text-2xl sm:text-3xl font-semibold tracking-tight first:mt-0 mb-4 mt-8 text-foreground flex items-center"><span class="w-1 h-6 bg-primary rounded-full mr-3"></span>$1</h2>'
	);
	html = html.replace(
		/<h3>(.*?)<\/h3>/g,
		'<h3 class="scroll-m-20 text-xl sm:text-2xl font-semibold tracking-tight mb-3 mt-6 text-foreground flex items-center"><span class="w-1 h-5 bg-blue-500 rounded-full mr-2"></span>$1</h3>'
	);
	html = html.replace(
		/<h4>(.*?)<\/h4>/g,
		'<h4 class="scroll-m-20 text-lg sm:text-xl font-semibold tracking-tight mb-2 mt-5 text-foreground flex items-center"><span class="w-1 h-4 bg-green-500 rounded-full mr-2"></span>$1</h4>'
	);

	// Bold/italic
	html = html.replace(
		/<strong>(.*?)<\/strong>/g,
		'<strong class="font-bold text-foreground">$1</strong>'
	);
	html = html.replace(
		/<em>(.*?)<\/em>/g,
		'<em class="italic text-muted-foreground font-medium">$1</em>'
	);

	// Images
	html = html.replace(
		/<img([^>]*)src="([^"]+)"([^>]*)>/g,
		(match: string, before: string, src: string, after: string) => {
			const fullSrc = convertRelativeUrl(src);
			return (
				"<div class='my-6 group'><img" +
				before +
				'src="' +
				fullSrc +
				'"' +
				after +
				' class="max-w-full h-auto rounded-lg border border-border shadow-md transition-all duration-300 group-hover:shadow-lg mx-auto block" /></div>'
			);
		}
	);

	// Links
	html = html.replace(
		/<a href="([^"]+)"([^>]*)>(.*?)<\/a>/g,
		(match: string, url: string, rest: string, text: string) => {
			const fullUrl = convertRelativeUrl(url);
			return (
				'<a href="' +
				fullUrl +
				'" target="_blank" class="font-medium text-primary underline underline-offset-4 hover:text-primary/80 transition-colors"' +
				rest +
				">" +
				text +
				"</a>"
			);
		}
	);

	// Lists
	html = html.replace(/<ul>/g, '<ul class="my-6 ml-6 list-none space-y-2">');
	html = html.replace(
		/<ol>/g,
		'<ol class="my-6 ml-6 list-decimal space-y-2 marker:text-muted-foreground">'
	);
	html = html.replace(
		/<li>/g,
		'<li class="text-foreground/90 leading-relaxed flex items-start"><span class="mt-2 mr-2 h-1.5 w-1.5 shrink-0 rounded-full bg-primary"></span><span>'
	);
	html = html.replace(/<\/li>/g, "</span></li>");

	// Todo checkboxes
	html = html.replace(
		/<input type="checkbox"([^>]*)>/g,
		'<input type="checkbox" class="mr-3 h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"$1>'
	);

	// Enhanced code blocks - adapted for rehype-pretty-code
	// rehype-pretty-code outputs <figure><pre>...</pre></figure> or just <pre>...</pre>
	// We want to add only the wrapper div and copy button, letting shiki handle the highlighting.
	html = html.replace(
		/(<pre[^>]*>[\s\S]*?<\/pre>)/g,
		(match: string, preContent: string) => {
			// Check if we can extract a language label from data attributes if present (optional)
			// But usually shiki styles are enough. We'll just add the copy button.

			const copyButton =
				'<button class="copy-button absolute right-4 top-4 p-2 rounded-md hover:bg-muted/50 text-muted-foreground transition-all duration-200 hover:text-primary z-20" onclick="copyCode(this)" title="Copy code">' +
				'<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>' +
				"</button>";

			return (
				'<div class="relative my-6 rounded-lg border border-border bg-muted/30 group overflow-hidden">' +
				copyButton +
				// We don't need to add language class or manually style pre as much,
				// but we can ensure it has some base scrolling.
				// Note: shiki adds its own style="background-color:..." so we should be careful not to override it too aggressively often.
				// We'll wrapper it.
				preContent +
				"</div>"
			);
		}
	);

	// Tables
	html = html.replace(
		/<table>/g,
		'<div class="my-6 w-full overflow-y-auto"><table class="w-full caption-bottom text-sm">'
	);
	html = html.replace(/<\/table>/g, "</table></div>");
	html = html.replace(/<thead>/g, '<thead class="[&_tr]:border-b">');
	html = html.replace(
		/<th>/g,
		'<th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">'
	);
	html = html.replace(
		/<td>/g,
		'<td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">'
	);
	html = html.replace(
		/<tr>/g,
		'<tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">'
	);

	// Paragraphs
	html = html.replace(
		/<p>/g,
		'<p class="leading-7 [&:not(:first-child)]:mt-6 text-foreground/90">'
	);

	// Blockquotes
	html = html.replace(
		/<blockquote>/g,
		'<blockquote class="mt-6 border-l-2 border-primary pl-6 italic text-muted-foreground">'
	);
	html = html.replace(/<\/blockquote>/g, "</blockquote>");

	return html;
}

if (content) {
	const processed = await renderMarkdownToHtml(content);
	html = enhanceHtml(processed);
} else {
	html = "<p>No content provided.</p>";
}
---

<div class="prose prose-neutral dark:prose-invert max-w-none" set:html={html} />

<script is:inline>
	function copyCode(button) {
		const pre = button.parentElement.querySelector("pre");
		const code = pre.textContent || pre.innerText;

		// Create a temporary textarea for older browsers
		const textarea = document.createElement("textarea");
		textarea.value = code;
		textarea.style.position = "fixed";
		textarea.style.opacity = "0";
		document.body.appendChild(textarea);

		try {
			// Try modern clipboard API first
			if (navigator.clipboard && window.isSecureContext) {
				navigator.clipboard
					.writeText(code)
					.then(() => {
						showCopyFeedback(button, true);
					})
					.catch(() => {
						// Fallback to selection method
						fallbackCopy();
					});
			} else {
				// Fallback for older browsers
				fallbackCopy();
			}
		} catch (err) {
			fallbackCopy();
		}

		function fallbackCopy() {
			textarea.select();
			textarea.setSelectionRange(0, 99999); // For mobile devices
			try {
				document.execCommand("copy");
				showCopyFeedback(button, true);
			} catch (err) {
				console.error("Failed to copy: ", err);
				showCopyFeedback(button, false);
			}
		}

		// Clean up
		document.body.removeChild(textarea);
	}

	function showCopyFeedback(button, success) {
		const originalHTML = button.innerHTML;

		if (success) {
			button.classList.add("text-green-500");
			button.innerHTML =
				'<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
			button.title = "Copied!";
		} else {
			button.classList.add("text-red-500");
			button.innerHTML =
				'<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
			button.title = "Failed to copy";
		}

		setTimeout(() => {
			button.classList.remove("text-green-500", "text-red-500");
			button.innerHTML = originalHTML;
			button.title = "Copy code";
		}, 2000);
	}
</script>

<script>
	import mermaid from "mermaid";
	mermaid.initialize({
		startOnLoad: true,
		theme: "dark",
	});
</script>
