---
import { remark } from "remark";
import remarkHtml from "remark-html";
import rehypePrism from "rehype-prism-plus";
import remarkGfm from "remark-gfm";

const { content, githubBaseUrl } = Astro.props;

let html = "";

function convertRelativeUrl(url: string): string {
	if (!githubBaseUrl) return url;
	if (url.startsWith("http://") || url.startsWith("https://")) return url;

	// Convert GitHub URL to raw.githubusercontent.com for images
	let baseUrl = githubBaseUrl;
	if (
		baseUrl.includes("github.com") &&
		!baseUrl.includes("raw.githubusercontent.com")
	) {
		baseUrl =
			baseUrl.replace("github.com", "raw.githubusercontent.com") + "/main";
	}

	let convertedUrl = url;
	if (url.startsWith("./")) {
		convertedUrl = baseUrl + "/" + url.substring(2);
	} else if (url.startsWith("../")) {
		convertedUrl = baseUrl + "/" + url.replace(/^\.\.\//, "");
	} else if (url.startsWith("/")) {
		convertedUrl = baseUrl + url;
	} else if (!url.includes("://") && !url.startsWith("#")) {
		convertedUrl = baseUrl + "/" + url;
	}
	return convertedUrl;
}

function enhanceHtml(rawHtml: string): string {
	let html = rawHtml;

	// Inline code - neo-brutalist (flat, crisp border, no rounded corners)
	html = html.replace(
		/<code>([^<\n]+)<\/code>/g,
		'<code class="px-1.5 py-0.5 text-[12px] font-mono border-2 border-border bg-card text-foreground">$1</code>'
	);

	// Headers - neo-brutalist: flat, underline, no gradients or pills
	html = html.replace(
		/<h1>(.*?)<\/h1>/g,
		'<h1 class="neo-heading !text-3xl !mb-4 mt-8 first:mt-0">$1</h1>'
	);
	html = html.replace(
		/<h2>(.*?)<\/h2>/g,
		'<h2 class="neo-heading !text-2xl !mb-3 mt-8 first:mt-0">$1</h2>'
	);
	html = html.replace(
		/<h3>(.*?)<\/h3>/g,
		'<h3 class="font-semibold tracking-tight text-lg mt-6 mb-2 border-b-2 border-border pb-1">$1</h3>'
	);
	html = html.replace(
		/<h4>(.*?)<\/h4>/g,
		'<h4 class="font-semibold text-base mt-5 mb-2">$1</h4>'
	);

	// Bold/italic - remove gradients
	html = html.replace(
		/<strong>(.*?)<\/strong>/g,
		'<strong class="font-bold text-foreground">$1</strong>'
	);
	html = html.replace(
		/<em>(.*?)<\/em>/g,
		'<em class="italic text-gray-700 dark:text-white/90 font-medium">$1</em>'
	);

	// Images - flatten styling
	html = html.replace(
		/<img([^>]*)src="([^"]+)"([^>]*)>/g,
		(match: string, before: string, src: string, after: string) => {
			const fullSrc = convertRelativeUrl(src);
			return (
				"<figure class='my-5'><img" +
				before +
				'src="' +
				fullSrc +
				'"' +
				after +
				' class="max-w-full h-auto border-2 border-border bg-card mx-auto block" /></figure>'
			);
		}
	);

	// Links - simple underline
	html = html.replace(
		/<a href="([^"]+)"([^>]*)>(.*?)<\/a>/g,
		(match: string, url: string, rest: string, text: string) => {
			const fullUrl = convertRelativeUrl(url);
			return (
				'<a href="' +
				fullUrl +
				'" target="_blank" class="underline decoration-2 decoration-border hover:bg-accent hover:text-accent-foreground transition-colors px-0.5">' +
				text +
				"</a>"
			);
		}
	);

	// Lists - simple bullets (no colored dots)
	html = html.replace(/<ul>/g, '<ul class="my-4 pl-6 list-disc space-y-1">');
	html = html.replace(
		/<ol>/g,
		'<ol class="my-3 sm:my-4 space-y-1 sm:space-y-2 list-decimal pl-4 sm:pl-6">'
	);
	// Remove injected span wrappers from previous style if any (safety)
	html = html.replace(/<li class=\"[^\"]*\"><span class=\"flex-1\">/g, "<li>");

	// Todo checkboxes - Enhanced styling for both themes
	html = html.replace(
		/<input type="checkbox"([^>]*)>/g,
		'<input type="checkbox" class="mr-2 sm:mr-3 mt-0.5 sm:mt-1 h-3 w-3 sm:h-4 sm:w-4 rounded border-2 border-gray-400 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-orange-500 focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-50 dark:focus:ring-offset-gray-800 transition-all duration-200"$1>'
	);

	// Code blocks with flat style
	html = html.replace(
		/<pre class="([^"]*)language-([^"]*)"([^>]*)>([\s\S]*?)<\/pre>/g,
		(
			match: string,
			classes: string,
			language: string,
			rest: string,
			content: string
		) => {
			const langLabel = language !== "text" ? language.toUpperCase() : "";
			const langLabelHtml = langLabel
				? '<div class="text-[10px] font-mono border-b-2 border-border px-2 py-1 bg-card">' +
					langLabel +
					"</div>"
				: "";
			const copyButton =
				'<button class="copy-button absolute top-1 right-1 border-2 border-border bg-card px-1.5 py-1 text-[10px] font-mono" onclick="copyCode(this)" title="Copy code">copy</button>';
			return (
				'<div class="relative my-6 border-2 border-border bg-card">' +
				langLabelHtml +
				copyButton +
				'<pre class="!m-0 p-4 overflow-x-auto text-sm leading-relaxed ' +
				classes +
				" language-" +
				language +
				'"' +
				rest +
				' style="white-space: pre; overflow-wrap: normal;">' +
				content +
				"</pre></div>"
			);
		}
	);

	// Tables - flat style, remove shadows & rounding
	html = html.replace(
		/<table>/g,
		'<div class="overflow-x-auto my-6 border-2 border-border"><table class="min-w-full bg-card">'
	);
	html = html.replace(/<\/table>/g, "</table></div>");
	html = html.replace(
		/<thead>/g,
		'<thead class="bg-gray-200 dark:bg-gray-800/60 border-b border-gray-300 dark:border-gray-700/50">'
	);
	html = html.replace(
		/<th>/g,
		'<th class="px-3 sm:px-6 py-2 sm:py-4 text-left text-xs sm:text-sm font-semibold text-gray-900 dark:text-white/95 border-r border-gray-300 dark:border-gray-700/30 last:border-r-0">'
	);
	html = html.replace(
		/<td>/g,
		'<td class="px-3 sm:px-6 py-2 sm:py-4 text-xs sm:text-sm text-gray-700 dark:text-white/80 border-r border-gray-300 dark:border-gray-700/20 last:border-r-0">'
	);
	html = html.replace(
		/<tr>/g,
		'<tr class="hover:bg-gray-100 dark:hover:bg-gray-700/30 transition-all duration-200 border-b border-gray-200 dark:border-gray-700/20 last:border-b-0">'
	);

	// Paragraphs - simplified
	html = html.replace(
		/<p>/g,
		'<p class="mb-4 leading-relaxed text-sm sm:text-base">'
	);

	// Blockquotes - neo style (left bar only)
	html = html.replace(
		/<blockquote>/g,
		'<blockquote class="border-l-4 border-border pl-4 my-6 text-sm leading-relaxed">'
	);
	html = html.replace(/<\/blockquote>/g, "</blockquote>");

	return html;
}

if (content) {
	const processed = await remark()
		.use(remarkGfm)
		.use(remarkHtml, { sanitize: false })
		.use(rehypePrism, {
			showLineNumbers: true,
			lineNumbers: true,
			plugins: ["line-numbers", "command-line", "diff-highlight"],
		})
		.process(content);
	html = enhanceHtml(processed.value.toString());
} else {
	html = "<p>No content provided.</p>";
}
---

<div
	class="prose prose-gray dark:prose-invert max-w-none space-y-4 sm:space-y-6"
	set:html={html}
/>

<script is:inline>
	function copyCode(button) {
		const pre = button.nextElementSibling;
		const code = pre.textContent || pre.innerText;

		// Create a temporary textarea for older browsers
		const textarea = document.createElement("textarea");
		textarea.value = code;
		textarea.style.position = "fixed";
		textarea.style.opacity = "0";
		document.body.appendChild(textarea);

		try {
			// Try modern clipboard API first
			if (navigator.clipboard && window.isSecureContext) {
				navigator.clipboard
					.writeText(code)
					.then(() => {
						showCopyFeedback(button, true);
					})
					.catch(() => {
						// Fallback to selection method
						fallbackCopy();
					});
			} else {
				// Fallback for older browsers
				fallbackCopy();
			}
		} catch (err) {
			fallbackCopy();
		}

		function fallbackCopy() {
			textarea.select();
			textarea.setSelectionRange(0, 99999); // For mobile devices
			try {
				document.execCommand("copy");
				showCopyFeedback(button, true);
			} catch (err) {
				console.error("Failed to copy: ", err);
				showCopyFeedback(button, false);
			}
		}

		// Clean up
		document.body.removeChild(textarea);
	}

	function showCopyFeedback(button, success) {
		const originalHTML = button.innerHTML;

		if (success) {
			button.classList.add("copied");
			button.innerHTML =
				'<svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
			button.title = "Copied!";
		} else {
			button.classList.add("error");
			button.innerHTML =
				'<svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
			button.title = "Failed to copy";
		}

		setTimeout(() => {
			button.classList.remove("copied", "error");
			button.innerHTML = originalHTML;
			button.title = "Copy code";
		}, 2000);
	}
</script>
