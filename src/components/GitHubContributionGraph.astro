---
import { Calendar } from "lucide-react";

// Fetch contribution data
let contributionData: any = null;
let currentYear = new Date().getFullYear();

try {
	const response = await fetch(`https://github-stats.tashif.codes/tashifkhan/contributions`);
	if (response.ok) {
		const data = await response.json();
		contributionData = data.contributions[currentYear]?.data || null;
	}
} catch (error) {
	console.error("Failed to fetch contribution data:", error);
}

// Helper function to get contribution level (0-4) based on count
function getContributionLevel(count: number): number {
	if (count === 0) return 0;
	if (count <= 3) return 1;
	if (count <= 6) return 2;
	if (count <= 9) return 3;
	return 4;
}

// Helper function to get color class based on contribution level
function getContributionColor(level: number): string {
	const colors = [
		"bg-gray-100 dark:bg-gray-800/50", // 0 contributions
		"bg-emerald-200 dark:bg-emerald-900/60", // 1-3 contributions
		"bg-emerald-300 dark:bg-emerald-700/70", // 4-6 contributions
		"bg-emerald-400 dark:bg-emerald-600/80", // 7-9 contributions
		"bg-emerald-500 dark:bg-emerald-500/90", // 10+ contributions
	];
	return colors[level] || colors[0];
}

// Helper function to format date for tooltip
function formatDate(dateString: string): string {
	return new Date(dateString).toLocaleDateString('en-US', {
		weekday: 'long',
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	});
}

const weeks = contributionData?.user?.contributionsCollection?.contributionCalendar?.weeks || [];
const totalContributions = weeks.reduce((total: number, week: any) => 
	total + week.contributionDays.reduce((weekTotal: number, day: any) => weekTotal + day.contributionCount, 0), 0
);

const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
---

<div
	class="relative bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl p-6 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 shadow-lg mb-6 sm:mb-8"
>
	<div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-t-2xl"></div>
	
	<div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
		<div class="flex items-center space-x-3">
			<div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl">
				<Calendar className="w-5 h-5 text-emerald-600 dark:text-emerald-400" />
			</div>
			<div>
				<h3 class="text-lg font-semibold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">
					{currentYear} Contribution Activity
				</h3>
				{contributionData && (
					<p class="text-sm text-gray-600 dark:text-gray-400">
						{totalContributions.toLocaleString()} contributions this year
					</p>
				)}
			</div>
		</div>
		
		<!-- Legend -->
		<div class="flex items-center space-x-2 text-xs text-gray-600 dark:text-gray-400">
			<span>Less</span>
			<div class="flex space-x-1">
				<div class="w-3 h-3 rounded-sm bg-gray-100 dark:bg-gray-800/50"></div>
				<div class="w-3 h-3 rounded-sm bg-emerald-200 dark:bg-emerald-900/60"></div>
				<div class="w-3 h-3 rounded-sm bg-emerald-300 dark:bg-emerald-700/70"></div>
				<div class="w-3 h-3 rounded-sm bg-emerald-400 dark:bg-emerald-600/80"></div>
				<div class="w-3 h-3 rounded-sm bg-emerald-500 dark:bg-emerald-500/90"></div>
			</div>
			<span>More</span>
		</div>
	</div>

	{contributionData ? (
		<div class="relative overflow-x-auto">
			<!-- Month labels -->
			<div class="flex justify-start mb-2 pl-12" style="min-width: 800px;">
				{monthLabels.map(month => (
					<span class="text-xs text-gray-500 dark:text-gray-400" style="width: 66px; text-align: center;">{month}</span>
				))}
			</div>
			
			<div class="flex" style="min-width: 800px;">
				<!-- Day labels -->
				<div class="flex flex-col justify-around text-xs text-gray-500 dark:text-gray-400 pr-2 h-28">
					<span>Sun</span>
					<span>Mon</span>
					<span>Tue</span>
					<span>Wed</span>
					<span>Thu</span>
					<span>Fri</span>
					<span>Sat</span>
				</div>
				
				<!-- Contribution grid -->
				<div class="flex space-x-1">
					{weeks.map((week: any) => (
						<div class="flex flex-col space-y-1">
							{week.contributionDays.map((day: any) => {
								const level = getContributionLevel(day.contributionCount);
								const colorClass = getContributionColor(level);
								return (
									<div
										class={`w-3 h-3 rounded-sm ${colorClass} hover:ring-2 hover:ring-emerald-300 dark:hover:ring-emerald-600 transition-all duration-200 cursor-help`}
										title={`${day.contributionCount} contributions on ${formatDate(day.date)}`}
									></div>
								);
							})}
						</div>
					))}
				</div>
			</div>
		</div>
	) : (
		<div class="text-center py-8">
			<div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-xl w-fit mx-auto mb-4">
				<Calendar className="w-8 h-8 text-gray-400 mx-auto" />
			</div>
			<p class="text-gray-500 dark:text-gray-400">
				Unable to load contribution data
			</p>
		</div>
	)}
</div>

<style>
	/* Custom scrollbar for the contribution grid */
	.overflow-x-auto::-webkit-scrollbar {
		height: 4px;
	}
	
	.overflow-x-auto::-webkit-scrollbar-track {
		background: transparent;
	}
	
	.overflow-x-auto::-webkit-scrollbar-thumb {
		background: rgba(156, 163, 175, 0.5);
		border-radius: 2px;
	}
	
	.overflow-x-auto::-webkit-scrollbar-thumb:hover {
		background: rgba(156, 163, 175, 0.7);
	}
</style>
