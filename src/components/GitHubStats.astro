---
import { githubStats } from "../data/github";
import GitHubContributionGraph from "./GitHubContributionGraph.astro";
import {
	GitCommit,
	Star,
	GitPullRequest,
	Users,
	TrendingUp,
	Calendar,
} from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";

const { stats, prs, stars, commits } = githubStats;

// Function to get language icon URL from Simple Icons
function getLanguageIcon(languageName: string): string {
	const iconMap: { [key: string]: string } = {
		JavaScript: "javascript",
		TypeScript: "typescript",
		Python: "python",
		Java: "openjdk",
		"C++": "cplusplus",
		"C#": "csharp",
		C: "c",
		PHP: "php",
		Ruby: "ruby",
		Go: "go",
		Rust: "rust",
		Swift: "swift",
		Kotlin: "kotlin",
		Dart: "dart",
		HTML: "html5",
		CSS: "css3",
		SCSS: "sass",
		Vue: "vuedotjs",
		React: "react",
		Angular: "angular",
		"Node.js": "nodedotjs",
		Express: "express",
		"Next.js": "nextdotjs",
		"Nuxt.js": "nuxtdotjs",
		Svelte: "svelte",
		Flutter: "flutter",
		"React Native": "react",
		Ionic: "ionic",
		Electron: "electron",
		MongoDB: "mongodb",
		PostgreSQL: "postgresql",
		MySQL: "mysql",
		Redis: "redis",
		Docker: "docker",
		Kubernetes: "kubernetes",
		AWS: "amazonaws",
		GCP: "googlecloud",
		Azure: "microsoftazure",
		Firebase: "firebase",
		Vercel: "vercel",
		Netlify: "netlify",
		Shell: "gnubash",
		PowerShell: "powershell",
		"Vim script": "vim",
		Lua: "lua",
		R: "r",
		MATLAB: "matlab",
		"Objective-C": "objectivec",
		Scala: "scala",
		Haskell: "haskell",
		Clojure: "clojure",
		Elixir: "elixir",
		Erlang: "erlang",
		"F#": "fsharp",
		Assembly: "assemblyscript",
		WebAssembly: "webassembly",
		Solidity: "solidity",
		YAML: "yaml",
		JSON: "json",
		XML: "xml",
		Markdown: "markdown",
		LaTeX: "latex",
		"Jupyter Notebook": "jupyter",
		Notebook: "jupyter",
		IPython: "jupyter",
		Astro: "astro",
	};

	const iconName =
		iconMap[languageName] ||
		languageName.toLowerCase().replace(/[^a-z0-9]/g, "");
	return `https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/${iconName}.svg`;
}

// Function to get fallback icon for unknown languages
function getFallbackIcon(): string {
	return `data:image/svg+xml,${encodeURIComponent(`
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
			<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
		</svg>
	`)}`;
}
---

<!-- Metrics Grid (Compact) -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4 mb-8">
	{
		[
			{
				label: "Commits",
				value: stats.totalCommits.toLocaleString(),
				sub: "lifetime",
				icon: GitCommit,
			},
			{
				label: "Streak",
				value: stats.currentStreak.toString(),
				sub: "current",
				icon: TrendingUp,
			},
			{
				label: "Longest",
				value: stats.longestStreak.toString(),
				sub: "streak",
				icon: Calendar,
			},
			{
				label: "Stars",
				value: stars.total_stars.toLocaleString(),
				sub: "total",
				icon: Star,
			},
			{
				label: "PRs",
				value: prs.length.toString(),
				sub: "opened",
				icon: GitPullRequest,
			},
			{
				label: "Views",
				value: stats.profile_visitors.toLocaleString(),
				sub: "profile",
				icon: Users,
			},
		].map((card) => (
			<Card className="group relative overflow-hidden border-border/50 bg-card/50 backdrop-blur-sm hover:border-primary/20 hover:shadow-sm transition-colors">
				<CardContent className="p-3 flex items-center gap-3">
					<div class="h-8 w-8 rounded-md bg-primary/10 flex items-center justify-center text-primary text-[13px] shadow-sm">
						<card.icon className="w-4 h-4" />
					</div>
					<div class="min-w-0 flex-1">
						<p class="text-[10px] uppercase tracking-wide font-medium text-muted-foreground truncate">
							{card.label}
						</p>
						<div class="flex items-baseline gap-1">
							<p class="text-lg font-semibold text-foreground tabular-nums leading-none overflow-hidden">
								{card.value}
							</p>
							<span class="text-[10px] text-muted-foreground/70 leading-none">
								{card.sub}
							</span>
						</div>
					</div>
				</CardContent>
			</Card>
		))
	}
</div>

<!-- GitHub Contribution Graph -->
<GitHubContributionGraph />

<!-- Top Languages (Minimalist) -->
<Card
	className="group relative overflow-hidden border-border/50 bg-card/50 backdrop-blur-sm mb-8 hover:border-primary/20 hover:shadow-sm"
>
	<CardHeader className="pb-2">
		<div class="flex items-center gap-3">
			<div
				class="h-9 w-9 rounded-lg bg-primary/10 flex items-center justify-center text-primary shadow-sm"
			>
				<svg
					class="w-4 h-4"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					><path d="M3 3h7v7H3z"></path><path d="M14 3h7v7h-7z"></path><path
						d="M14 14h7v7h-7z"></path><path d="M3 14h7v7H3z"></path></svg
				>
			</div>
			<div>
				<CardTitle
					className="text-base font-semibold text-foreground tracking-tight"
				>
					Top Languages
				</CardTitle>
				<p class="text-xs text-muted-foreground">
					Most used across public repos
				</p>
			</div>
		</div>
	</CardHeader>
	<CardContent>
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
			{
				stats.topLanguages.slice(0, 6).map((lang) => (
					<div class="group/lng relative flex items-center justify-between gap-4 rounded-xl border border-border/40 bg-background/40 px-3 py-3 hover:border-primary/20 transition-colors">
						<div class="flex items-center gap-3 min-w-0">
							<div class="relative flex items-center justify-center w-9 h-9 rounded-lg bg-background/60 shadow-sm border border-border/30 overflow-hidden">
								<img
									src={getLanguageIcon(lang.name)}
									alt={`${lang.name} icon`}
									class="w-5 h-5 object-contain language-icon dark:text-gray-700"
									data-fallback={getFallbackIcon()}
								/>
								<div
									class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full shadow-sm border border-background"
									style={`background-color: ${lang.color}`}
								/>
							</div>
							<div class="space-y-0.5 min-w-0">
								<p class="text-sm font-medium text-foreground truncate">
									{lang.name}
								</p>
								<div
									class="w-24 h-1 bg-secondary rounded-full overflow-hidden"
									role="progressbar"
									aria-valuemin="0"
									aria-valuemax="100"
									aria-valuenow={String(
										Math.max(0, Math.min(100, Number(lang.percentage) || 0))
									)}
									aria-label={`${lang.name} usage`}
								>
									<div
										class="h-full bg-[color:var(--c)] rounded-full transition-all duration-500"
										style={`--c: ${lang.color}; width: ${Math.max(0, Math.min(100, Number(lang.percentage) || 0))}%;`}
									/>
								</div>
							</div>
						</div>
						<span class="text-xs font-semibold tabular-nums text-muted-foreground">
							{Math.round(
								Math.max(0, Math.min(100, Number(lang.percentage) || 0))
							)}
							%
						</span>
					</div>
				))
			}
		</div>
	</CardContent>
</Card>

<!-- Recent Activity (Minimalist) -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-2">
	{
		(
			[
				{
					title: "Recent Commits",
					icon: GitCommit,
					items: commits
						.slice(0, 5)
						.map((c) => ({ type: "commit" as const, data: c })),
					kind: "commit" as const,
				},
				{
					title: "Recent Pull Requests",
					icon: GitPullRequest,
					items: prs.slice(0, 5).map((p) => ({ type: "pr" as const, data: p })),
					kind: "pr" as const,
				},
			] as const
		).map((panel) => (
			<Card className="group relative overflow-hidden border-border/50 bg-card/50 backdrop-blur-sm transition-all duration-300 hover:border-primary/20 hover:shadow-sm">
				<CardHeader className="pb-2">
					<div class="flex items-center gap-3">
						<div class="h-9 w-9 rounded-lg bg-primary/10 flex items-center justify-center text-primary shadow-sm">
							<panel.icon className="w-4 h-4" />
						</div>
						<CardTitle className="text-base font-semibold text-foreground tracking-tight">
							{panel.title}
						</CardTitle>
					</div>
				</CardHeader>
				<CardContent>
					<div class="space-y-2.5">
						{panel.items.map((entry) => {
							const isCommit = entry.type === "commit";
							// @ts-ignore - dynamic shape awareness
							const commit = isCommit ? entry.data : null;
							// @ts-ignore
							const pr = !isCommit ? entry.data : null;
							return (
								<div class="group/item flex items-start gap-3 rounded-xl border border-border/40 bg-background/40 px-3 py-2.5 hover:border-primary/20 transition-colors">
									<div class="mt-0.5 h-2.5 w-2.5 rounded-sm bg-primary/20 ring-1 ring-inset ring-primary/30" />
									<div class="flex-1 min-w-0">
										<p class="text-[13px] font-medium text-foreground truncate">
											{isCommit ? commit!.message : pr!.title}
										</p>
										<p class="text-[11px] text-muted-foreground mt-0.5 flex flex-wrap gap-x-1">
											{isCommit ? (
												<>
													<span class="truncate max-w-[120px]">
														{commit!.repo}
													</span>
													<span>•</span>
													<span>
														{new Date(commit!.timestamp).toLocaleDateString()}
													</span>
												</>
											) : (
												<>
													<span class="truncate max-w-[120px]">{pr!.repo}</span>
													<span>•</span>
													<span class="capitalize">{pr!.state}</span>
													<span>•</span>
													<span>
														{new Date(pr!.created_at).toLocaleDateString()}
													</span>
												</>
											)}
										</p>
									</div>
								</div>
							);
						})}
					</div>
				</CardContent>
			</Card>
		))
	}
</div>

<script>
	// Handle language icon loading and styling
	document.addEventListener("DOMContentLoaded", function () {
		const languageIcons = document.querySelectorAll(".language-icon");

		languageIcons.forEach((icon) => {
			const img = icon as HTMLImageElement;

			// Function to apply correct theme styling
			function applyThemeStyle() {
				const isDark = document.documentElement.classList.contains("dark");

				// Don't apply filter if this is a fallback icon
				if (img.src.startsWith("data:image/svg+xml")) {
					img.style.filter = "none";
					img.style.color = isDark ? "#9CA3AF" : "#6B7280";
					return;
				}

				// Simple Icons are typically black SVGs, so we need to handle them properly
				if (isDark) {
					// For dark mode, invert the black icons to white
					img.style.filter = "invert(1) brightness(0.9)";
				} else {
					// For light mode, keep icons darker but not completely black
					img.style.filter = "brightness(0.7)";
				}
			}

			// Set initial styling
			img.style.opacity = "0.9";
			img.style.transition = "all 0.3s ease";
			applyThemeStyle();

			// Handle successful load
			img.addEventListener("load", function () {
				this.style.opacity = "1";
				applyThemeStyle();
			});

			// Handle error loading
			img.addEventListener("error", function () {
				const fallbackUrl = this.dataset.fallback;
				if (fallbackUrl && this.src !== fallbackUrl) {
					this.src = fallbackUrl;
					applyThemeStyle();
				}
			});

			// Apply dark mode styling when theme changes
			const observer = new MutationObserver(() => {
				applyThemeStyle();
			});

			observer.observe(document.documentElement, {
				attributes: true,
				attributeFilter: ["class"],
			});
		});
	});
</script>
